<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">

		<title>livecam UI</title>

		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">

		<style type="text/css">
			html,body,.feed,.feed img {
				width:100%;
				height:100%;
				overflow:hidden;
			}
		</style>

	</head>

	<body>
		<div class="feed"><img id="video" src="" /></div>
		<script>
			const serverAddress = "{{uiAddress}}";
			const serverPort = "{{uiPort}}";
			const webcamAddress = "{{webcamAddress}}";
			const webcamPort = "{{webcamPort}}";
			const webcamHost = document.querySelector(".feed img");
			const socket = io.connect(`http://${webcamAddress}:${webcamPort}`);
			const socketGamepad = io.connect(`http://${serverAddress}:${serverPort}`);

			socket.on('image', function (data: any) {
				webcamHost.setAttribute("src", `data:image/jpeg;base64,${data}`);
			});

			window.addEventListener('gamepadconnected', function (event) {
				console.log(event);
				const gp = navigator.getGamepads()[(event as GamepadEvent).gamepad.index];
				console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",
					gp.index, gp.id,gp.buttons.length, gp.axes.length
				);
				window.requestAnimationFrame(() => gamepadListener());
			});

			function gamepadListener ()
			{
				const gp = navigator.getGamepads()[0];

				if (gp) {
					// Map buttons to object
					const gamepadState = {
						left: gp.axes[0] === -1,
						right: gp.axes[0] === 1,
						xCenter: gp.axes[0] === 0,
						up: gp.axes[1] === -1,
						down: gp.axes[1] === 1,
						yCenter: gp.axes[1] === 0,
						a: gp.buttons[0].pressed,
						b: gp.buttons[1].pressed,
						x: gp.buttons[3].pressed,
						y: gp.buttons[4].pressed,
						lt: gp.buttons[6].pressed,
						rt: gp.buttons[7].pressed,
						start: gp.buttons[11].pressed,
						select: gp.buttons[10].pressed
					};

					// Send buttons state via socket
					socketGamepad.emit('buttons:state', gamepadState);
				}

				window.requestAnimationFrame(() => gamepadListener());
			}

		</script>
	</body>
</html>
